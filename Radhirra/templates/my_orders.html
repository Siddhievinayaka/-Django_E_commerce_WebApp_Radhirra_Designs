{% extends 'layout.html' %}
{% load static %}

{% block title %}My Orders - Radhirra Designs{% endblock %}

{% block content %}
{% if user.is_authenticated %}
<div class="container mx-auto px-2 sm:px-4 py-4 sm:py-8">
  <!-- Page Header -->
  <div class="mb-6 sm:mb-8">
    <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 dark:text-text-main mb-2">My Orders</h1>
    <p class="text-sm sm:text-base text-gray-600 dark:text-text-secondary">Track and manage your orders</p>
  </div>

  <!-- Filter Tabs -->
  <div class="mb-4 sm:mb-6">
    <div class="flex flex-wrap gap-1 sm:gap-2 border-b border-gray-200 dark:border-gray-600 overflow-x-auto">
      <button onclick="filterOrders('all')" class="order-filter-btn px-2 sm:px-4 py-2 text-xs sm:text-sm font-medium border-b-2 border-primary text-primary whitespace-nowrap">All Orders</button>
      <button onclick="filterOrders('pending')" class="order-filter-btn px-2 sm:px-4 py-2 text-xs sm:text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 whitespace-nowrap">Pending</button>
      <button onclick="filterOrders('confirmed')" class="order-filter-btn px-2 sm:px-4 py-2 text-xs sm:text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 whitespace-nowrap">Confirmed</button>
      <button onclick="filterOrders('completed')" class="order-filter-btn px-2 sm:px-4 py-2 text-xs sm:text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 whitespace-nowrap">Completed</button>
      <button onclick="filterOrders('cancelled')" class="order-filter-btn px-2 sm:px-4 py-2 text-xs sm:text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 whitespace-nowrap">Cancelled</button>
    </div>
  </div>

  <!-- Loading State -->
  <div id="loading-state" class="text-center py-12">
    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"></div>
    <p class="text-gray-500">Loading your orders...</p>
  </div>

  <!-- Orders Container -->
  <div id="orders-container" class="space-y-6 hidden">
    <!-- Orders will be loaded here via JavaScript -->
  </div>

  <!-- Empty State -->
  <div id="empty-state" class="text-center py-12 sm:py-16 hidden">
    <div class="w-20 h-20 sm:w-24 sm:h-24 mx-auto mb-4 sm:mb-6 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center">
      <svg class="w-10 h-10 sm:w-12 sm:h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
      </svg>
    </div>
    <h3 class="text-lg sm:text-xl font-semibold text-gray-900 dark:text-text-main mb-2">No orders found</h3>
    <p class="text-sm sm:text-base text-gray-600 dark:text-text-secondary mb-4 sm:mb-6">You haven't placed any orders yet.</p>
    <a href="{% url 'all_products' %}" class="inline-block bg-primary hover:bg-primary/90 text-white font-semibold py-2 sm:py-3 px-4 sm:px-6 rounded-lg transition-colors text-sm sm:text-base">Start Shopping</a>
  </div>
</div>
{% else %}
<div class="container mx-auto px-2 sm:px-4 py-8 text-center">
  <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 mb-4">Please Login</h1>
  <p class="text-sm sm:text-base text-gray-600 mb-6">You need to be logged in to view your orders.</p>
  <a href="/users/login/" class="inline-block bg-primary hover:bg-primary/90 text-white font-semibold py-2 sm:py-3 px-4 sm:px-6 rounded-lg transition-colors text-sm sm:text-base">Login</a>
</div>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
  loadOrders();
});

function loadOrders() {
  // Show loading state
  document.getElementById('loading-state').classList.remove('hidden');
  document.getElementById('orders-container').classList.add('hidden');
  document.getElementById('empty-state').classList.add('hidden');
  
  // Fetch orders from API
  fetch('{% url "get_user_orders" %}')
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        renderOrders(data.orders);
      } else {
        renderOrders([]);
      }
    })
    .catch(error => {
      console.error('Error loading orders:', error);
      renderOrders([]);
    });
}

function renderOrders(orders) {
  const container = document.getElementById('orders-container');
  const loadingState = document.getElementById('loading-state');
  const emptyState = document.getElementById('empty-state');
  
  loadingState.classList.add('hidden');
  
  if (orders.length === 0) {
    emptyState.classList.remove('hidden');
    return;
  }
  
  container.innerHTML = orders.map(order => createOrderCard(order)).join('');
  container.classList.remove('hidden');
}

function createOrderCard(order) {
  const statusColors = {
    pending: 'bg-yellow-100 text-yellow-800',
    confirmed: 'bg-blue-100 text-blue-800',
    completed: 'bg-green-100 text-green-800',
    cancelled: 'bg-red-100 text-red-800'
  };
  
  const typeIcons = {
    whatsapp: 'ðŸ“±',
    email: 'ðŸ“§'
  };
  
  return `
    <div class="order-card bg-white dark:bg-light-bg rounded-xl sm:rounded-2xl shadow-lg p-4 sm:p-6 transition-all duration-300 hover:shadow-xl" data-status="${order.order_status}">
      <!-- Order Header -->
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4 pb-4 border-b border-gray-200 dark:border-gray-600">
        <div class="mb-3 sm:mb-0">
          <div class="flex items-center gap-2 mb-1">
            <h3 class="text-base sm:text-lg font-semibold text-gray-900 dark:text-text-main">Order #${order.id}</h3>
            <span class="text-base sm:text-lg">${typeIcons[order.order_type]}</span>
          </div>
          <p class="text-xs sm:text-sm text-gray-500 dark:text-text-secondary">Placed on ${new Date(order.date_ordered).toLocaleDateString()}</p>
        </div>
        <div class="flex items-center justify-between sm:justify-end gap-3">
          <span class="px-2 sm:px-3 py-1 rounded-full text-xs font-medium ${statusColors[order.order_status]}">${order.order_status.charAt(0).toUpperCase() + order.order_status.slice(1)}</span>
          <span class="text-base sm:text-lg font-bold text-gray-900 dark:text-text-main">â‚¹${order.total_amount}</span>
        </div>
      </div>
      
      <!-- Order Items -->
      <div class="space-y-3 sm:space-y-4">
        ${order.items.map(item => `
          <div class="flex flex-col xs:flex-row items-start xs:items-center gap-3 sm:gap-4">
            <!-- Product Image -->
            <div class="flex-shrink-0 w-full xs:w-auto">
              <div class="w-14 h-14 xs:w-16 xs:h-16 sm:w-20 sm:h-20 rounded-lg overflow-hidden bg-gray-100 mx-auto xs:mx-0">
                <img src="${item.product_image}" alt="${item.product_name}" class="w-full h-full object-cover" onerror="this.src='/static/images/no-image.png'" />
              </div>
            </div>
            
            <!-- Product Details -->
            <div class="flex-grow min-w-0  xs:text-left">
              <h4 class="font-medium text-gray-900 dark:text-text-main mb-1 text-sm sm:text-base">${item.product_name}</h4>
              <p class="text-xs sm:text-sm text-gray-500 dark:text-text-secondary mb-1">${item.variant_info}</p>
              <div class="flex items-center  xs:justify-start gap-2 sm:gap-4 text-xs sm:text-sm">
                <span class="text-gray-600 dark:text-text-secondary">Qty: ${item.quantity}</span>
                <span class="font-medium text-gray-900 dark:text-text-main">â‚¹${item.price_at_order} each</span>
              </div>
            </div>
            
            <!-- Item Total -->
            <div class="flex-shrink-0  xs:text-right w-full xs:w-auto">
              <p class="font-semibold text-gray-900 dark:text-text-main text-sm sm:text-base">â‚¹${item.price_at_order * item.quantity}</p>
            </div>
          </div>
        `).join('')}
      </div>
      
      <!-- Order Actions -->
      <div class="mt-4 sm:mt-6 pt-4 border-t border-gray-200 dark:border-gray-600 flex flex-col sm:flex-row gap-2 sm:gap-3">
        <button onclick="viewOrderDetails(${order.id})" class="flex-1 sm:flex-none px-3 sm:px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors text-xs sm:text-sm font-medium">View Details</button>
        ${order.order_status === 'pending' ? `
          <button onclick="cancelOrder(${order.id})" class="flex-1 sm:flex-none px-3 sm:px-4 py-2 border border-red-300 text-red-700 rounded-lg hover:bg-red-50 transition-colors text-xs sm:text-sm font-medium">Cancel Order</button>
        ` : ''}
        ${order.order_status === 'completed' ? `
          <button onclick="reorderItems(${order.id})" class="flex-1 sm:flex-none px-3 sm:px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors text-xs sm:text-sm font-medium">Reorder</button>
        ` : ''}
      </div>
    </div>
  `;
}

function filterOrders(status) {
  // Update active tab
  document.querySelectorAll('.order-filter-btn').forEach(btn => {
    btn.classList.remove('border-primary', 'text-primary');
    btn.classList.add('border-transparent', 'text-gray-500');
  });
  event.target.classList.remove('border-transparent', 'text-gray-500');
  event.target.classList.add('border-primary', 'text-primary');
  
  // Filter order cards
  const orderCards = document.querySelectorAll('.order-card');
  orderCards.forEach(card => {
    if (status === 'all' || card.dataset.status === status) {
      card.style.display = 'block';
    } else {
      card.style.display = 'none';
    }
  });
}

function viewOrderDetails(orderId) {
  // Create modal for order details
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
  modal.innerHTML = `
    <div class="bg-white rounded-lg p-6 max-w-md w-full max-h-96 overflow-y-auto">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-bold">Order #${orderId} Details</h3>
        <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div id="order-details-content">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto"></div>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
  window.currentModal = modal;
  
  // Fetch order details
  fetch(`{% url "get_order_details" 0 %}`.replace('0', orderId))
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        document.getElementById('order-details-content').innerHTML = `
          <div class="space-y-3">
            <p><strong>Status:</strong> ${data.order.order_status}</p>
            <p><strong>Type:</strong> ${data.order.order_type}</p>
            <p><strong>Total:</strong> â‚¹${data.order.total_amount}</p>
            <p><strong>Contact:</strong> ${data.order.contact_value}</p>
            <div class="border-t pt-3">
              <h4 class="font-semibold mb-2">Items:</h4>
              ${data.order.items.map(item => `
                <div class="text-sm mb-2">
                  <p>${item.product_name} x${item.quantity}</p>
                  <p class="text-gray-600">${item.variant_info}</p>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }
    })
    .catch(() => {
      document.getElementById('order-details-content').innerHTML = '<p class="text-red-500">Error loading details</p>';
    });
}

function cancelOrder(orderId) {
  if (confirm('Are you sure you want to cancel this order?')) {
    fetch(`{% url "cancel_order" 0 %}`.replace('0', orderId), {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCookie('csrftoken'),
        'Content-Type': 'application/json'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert('Order cancelled successfully');
        loadOrders(); // Reload orders
      } else {
        alert('Error cancelling order: ' + data.error);
      }
    })
    .catch(() => alert('Error cancelling order'));
  }
}

function reorderItems(orderId) {
  if (confirm('Add all items from this order to your cart?')) {
    fetch(`{% url "reorder_items" 0 %}`.replace('0', orderId), {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCookie('csrftoken'),
        'Content-Type': 'application/json'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert('Items added to cart successfully');
        window.location.href = '{% url "cart" %}';
      } else {
        alert('Error adding items to cart: ' + data.error);
      }
    })
    .catch(() => alert('Error adding items to cart'));
  }
}

function closeModal() {
  if (window.currentModal) {
    document.body.removeChild(window.currentModal);
    window.currentModal = null;
  }
}

function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
</script>
{% endblock %}